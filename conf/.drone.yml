# drone 本地构建
kind: pipeline
type: docker
name: note-deploy

# drone执行触发器
trigger:
  branch:
    - master

volumes:
  - name: cache
    host:
      path: /root

# drone构建步骤
steps:
  # 1.打成docke
  - name: docker-build
    pull: if-not-exists
    image: plugins/docker
    settings:
      registry: local-repo:5000
      insecure: true
      repo: local-repo:5000/0moe-note
      tags: 
        - latest
        - ${DRONE_COMMIT_SHA}
      dockerfile: conf/Dockerfile
  # 2.部署到k3s
  - name: ssh commands
    image: appleboy/drone-ssh
    settings:
      host: 122.51.158.110
      username: root
      port: 22
      key:
        from_secret: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6uqHGfuSEqeJHwRnl8sE3Yk/7dsuk8GRJ5kEHCM2cn9zPB/xQ9DEAXp4PCXVLRQkz+gUmi0R0CV7ksun3RBqdTXxlMBqEDC3T/LZk9baBi7LB5yWUb2veu3ztRf7ezjL6k4HZ4JMwd1sND2jireBQ4nn+EuskdC7beClDwswHbr3mBP1YhqO7eUmwLeBGJHIrYRi6Zf/B425pwGZw0Acd17jou9LT2gzZGEesQzBLf6rneCmaFEH4poR53NvSrw/fnZpaqleHxgXFGz/YU/Ra/UBFZAFTnBS0oGm2g2fZGLN9Xv5m1pg3h2TRFlfvTc+jjDj42rlUkTfzK66wZ56d 571833559@qq.com'
      script:
        - echo hello
        - echo world
  # 4.邮件通知
  - name: email-notice
    pull: if-not-exists
    image: drillster/drone-email
    settings:
      host: smtp.exmail.qq.com
      port: 465
      username: system@0moe.cn
      password: MjEcKARP3qAECSMS
      from: system@0moe.cn
    when:
      status: [failure, success]