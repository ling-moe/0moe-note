<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>分布式事务选型对比</title>
    <link href="/2021/01/13/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%80%89%E5%9E%8B%E5%AF%B9%E6%AF%94/"/>
    <url>/2021/01/13/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%80%89%E5%9E%8B%E5%AF%B9%E6%AF%94/</url>
    
    <content type="html"><![CDATA[<h1 id="分布式事务选型对比"><a href="#分布式事务选型对比" class="headerlink" title="分布式事务选型对比"></a>分布式事务选型对比</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着互联网架构的不断扩展，传统的ACID事务已经无法满足要求。为了解决这个问题，BASE理论被提出来取代ACID，基于BASE理论和CAP理论的分布式事务也有各种事务策略。如何保证整个事务整体的原子性与一致性问题？分布式事务如何选项才能更加适合当下的业务场景？已经成为了当下事务的痛点。</p><a id="more"></a><h2 id="解决方案对比"><a href="#解决方案对比" class="headerlink" title="解决方案对比"></a>解决方案对比</h2><h3 id="2PC两阶段提交"><a href="#2PC两阶段提交" class="headerlink" title="2PC两阶段提交"></a>2PC两阶段提交</h3><h4 id="XA方案"><a href="#XA方案" class="headerlink" title="XA方案"></a>XA方案</h4><p>为了提供统一的对接模型和标准，X/OPEN组织提出了一个DTP（Distributed Transaction Processing Reference Model）模型，其中规定了分布式事务中的三个角色：</p><ul><li>AP：应用程序</li><li>TM：事务管理器，负责协调管理整个分布式事务</li><li>RM：资源管理器也就是事务参与者，负责控制分支事务</li></ul><p>DTP模型还定义了TM和RM之间通信的接口规范，这个规范就是XA，本职上也是数据库提供的2PC接口协议。基于XA方案的事务流程如下：</p><ul><li>AP 持有 D1 和 D2 两个数据源；</li><li>AP 通过 TM 通知 D1 的 RM 操作数据，同时通知 D2 的 TM 操作数据，此时 D1 和 D2 操作的数据锁定，RM 不提交事务；</li><li>TM 收到 两个数据源的 RM 执行恢复，只要有一方失败，则向另外的 RM 发起回滚指令，对应 RM 回滚分支事务释放资源锁；</li><li>若均为成功，TM 向所有 RM 发起提交指令，所有 RM 接到指令提交事务，释放资源锁。</li></ul><p>XA方案本质上是数据库层面的分布式事务，要求数据库支持事务，实现强一致性。在整个事务流程中，从准备阶段到第二阶段的commit或rollback的整个过程中，TM一直持有对应相关数据资源的锁，如果有其他事务要修改数据库的该条数据，就必须等待锁的释放，存在长事务风险。</p><h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>适合于本地的多事务组合，对于基于网络io的分布式事务，由于无法解决io丢失问题，因此并不可靠</p><h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p>关于TCC（Try-Confirm-Cancel）的概念，最早是由Pat Helland于2007年发表的一篇名为《Life beyond Distributed Transactions:an Apostate’s Opinion》的论文提出。 TCC事务机制相比于上面介绍的XA，解决了其几个缺点: 1.解决了协调者单点，由主业务方发起并完成这个业务活动。业务活动管理器也变成多点，引入集群。 2.同步阻塞:引入超时，超时后进行补偿，并且不会锁定整个资源，将资源转换为业务逻辑形式，粒度变小。 3.数据一致性，有了补偿机制之后，由业务活动管理器控制一致性</p><p>对于TCC的解释:</p><ul><li>Try阶段：尝试执行,完成所有业务检查（一致性）,预留必须业务资源（准隔离性）</li><li>Confirm阶段：确认执行真正执行业务，不作任何业务检查，只使用Try阶段预留的业务资源，Confirm操作满足幂等性。要求具备幂等设计，Confirm失败后需要进行重试。</li><li>Cancel阶段：取消执行，释放Try阶段预留的业务资源 Cancel操作满足幂等性Cancel阶段的异常和Confirm阶段异常处理方案基本上一致。</li></ul><p>举个简单的例子如果你用100元买了一瓶水， Try阶段:你需要向你的钱包检查是否够100元并锁住这100元，水也是一样的。</p><p>如果有一个失败，则进行cancel(释放这100元和这一瓶水)，如果cancel失败不论什么失败都进行重试cancel，所以需要保持幂等。</p><p>如果都成功，则进行confirm,确认这100元扣，和这一瓶水被卖，如果confirm失败无论什么失败则重试(会依靠活动日志进行重试)</p><p>对于TCC来说适合一些:</p><ul><li>强隔离性，严格一致性要求的活动业务。</li><li>执行时间较短的业务</li></ul><h4 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h4><p>TCC的特点在于业务资源检查与加锁，一阶段进行校验，资源锁定，如果第一阶段都成功，二阶段对锁定资源进行交易逻辑，否则，对锁定资源进行释放。应用实施成本较高。</p><h3 id="MQ事务"><a href="#MQ事务" class="headerlink" title="MQ事务"></a>MQ事务</h3><p>RocketMQ在4.3版本开始支持事务消息，即prepare消息。这种消息在发送到MQ之后不会立即投递到消费者，会由发送者二次确认后，由RocketMQ根据确认指令决定投递还是丢弃。基于该方案的整个事务流程如下：</p><ul><li>事务发起方发送prepare消息到RocketMQ，RocketMQ存储该消息并反馈发起方消息接收成功，prepare消息不允许被消费者消费。</li><li>发起方接收到RocketMQ的反馈后，执行本地事务，若本地事务执行成功，发起方向RocketMQ发送prepare消息的commit指令，否则发送rolback。</li><li>RocketMQ接收到发起方二次对prepare消息的确认指令后，执行消息的对应操作，commit控制消息进入实际的消费队列，rollback会删除对应消息，至此，保证了本地事务与消息发送的原子性问题。</li><li>对于事务发起方二次确认的可靠性问题，RocketMQ提供反向的定时任务汇差事务状态机制，最多重试15次，超过则丢弃消息。</li><li>事务参与者监听RocketMQ，基于消息确认（ACK）机制，参与者接收到消息并业务处理完成后向RocketMQ发送ack，保证参与者接收消息的可靠性问题。</li><li>事务参与者对事务消息的消费方法实现幂等性，解决可能存在的消息重复消费问题。</li></ul><h4 id="结论-2"><a href="#结论-2" class="headerlink" title="结论"></a>结论</h4><p>适合非主要流程的事务处理，如电商中的评论，物流信息等。允许丢失部分信息，必要时可人工干预。</p><h3 id="saga事务"><a href="#saga事务" class="headerlink" title="saga事务"></a>saga事务</h3><p>Saga是30年前一篇数据库伦理提到的一个概念。其核心思想是将长事务拆分为多个本地短事务，由Saga事务协调器协调，如果正常结束那就正常完成，如果某个步骤失败，则根据相反顺序一次调用补偿操作。 Saga的组成：</p><p>每个Saga由一系列sub-transaction Ti 组成 每个Ti 都有对应的补偿动作Ci，补偿动作用于撤销Ti造成的结果,这里的每个T，都是一个本地事务。 可以看到，和TCC相比，Saga没有“预留 try”动作，它的Ti就是直接提交到库。</p><p>Saga的执行顺序有两种：</p><p>T1, T2, T3, …, Tn</p><p>T1, T2, …, Tj, Cj,…, C2, C1，其中0 &lt; j &lt; n Saga定义了两种恢复策略：</p><p>向后恢复，即上面提到的第二种执行顺序，其中j是发生错误的sub-transaction，这种做法的效果是撤销掉之前所有成功的sub-transation，使得整个Saga的执行结果撤销。 向前恢复，适用于必须要成功的场景，执行顺序是类似于这样的：T1, T2, …, Tj(失败), Tj(重试),…, Tn，其中j是发生错误的sub-transaction。该情况下不需要Ci。</p><p>这里要注意的是，在saga模式中不能保证隔离性，因为没有锁住资源，其他事务依然可以覆盖或者影响当前事务。</p><p>还是拿100元买一瓶水的例子来说，这里定义</p><p>T1=扣100元 T2=给用户加一瓶水 T3=减库存一瓶水</p><p>C1=加100元 C2=给用户减一瓶水 C3=给库存加一瓶水</p><p>我们一次进行T1,T2，T3如果发生问题，就执行发生问题的C操作的反向。 上面说到的隔离性的问题会出现在，如果执行到T3这个时候需要执行回滚，但是这个用户已经把水喝了(另外一个事务)，回滚的时候就会发现，无法给用户减一瓶水了。这就是事务之间没有隔离性的问题</p><p>可以看见saga模式没有隔离性的影响还是较大，可以参照华为的解决方案:从业务层面入手加入一 Session 以及锁的机制来保证能够串行化操作资源。也可以在业务层面通过预先冻结资金的方式隔离这部分资源， 最后在业务操作的过程中可以通过及时读取当前状态的方式获取到最新的更新。</p><h4 id="结论-3"><a href="#结论-3" class="headerlink" title="结论"></a>结论</h4><p>Saga的核心就是补偿，一阶段就是服务的正常顺序调用（数据库事务正常提交），如果都执行成功，则第二阶段则什么都不做；但如果其中有执行发生异常，则依次调用其补偿服务（一般多逆序调用未已执行服务的反交易）来保证整个交易的一致性。应用实施成本一般。</p>]]></content>
    
    
    
    <tags>
      
      <tag>事务</tag>
      
      <tag>分布式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>从绫开始的k3s到istio（一）：安装K3S</title>
    <link href="/2020/06/19/%E4%BB%8E%E7%BB%AB%E5%BC%80%E5%A7%8B%E7%9A%84k3s%E5%88%B0istio%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2020/06/19/%E4%BB%8E%E7%BB%AB%E5%BC%80%E5%A7%8B%E7%9A%84k3s%E5%88%B0istio%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="从绫开始的k3s到istio（一）：安装K3S"><a href="#从绫开始的k3s到istio（一）：安装K3S" class="headerlink" title="从绫开始的k3s到istio（一）：安装K3S"></a>从绫开始的k3s到istio（一）：安装K3S</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为k8s太大了嘛，就一直想搞也莫得银子。正巧从逼乎上看到了k3s，也是挺有意思，正好我服务器也能勉强带的动（2C4G）就搞了一个。这个系列主要使用k3s+istio。从k3s安装，配置资源服务，部署代码，自动化构建到状态监控等，会一直更新下去。</p><a id="more"></a><h2 id="K3S安装"><a href="#K3S安装" class="headerlink" title="K3S安装"></a>K3S安装</h2><p>安装前有几点注意：</p><ul><li><p>hostname。</p><p>因为k3s的node节点有命名规则，只允许字母、数字和中划线(<code>-</code>)。并且节点名称默认名称使用hostname，因此某些云服务商的默认命名可能有问题，比如VM_6。这种节点是无法创建成功的，因此我们首先要重命名hostname。</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">sudo hostnamectl set-hostname &lt;newhostname&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p>用istio代替traefik做反向代理</p><p>因为traefik不支持mysql、redis等协议代理，因此我们用istio做反代</p></li></ul><h3 id="国内源安装k3s"><a href="#国内源安装k3s" class="headerlink" title="国内源安装k3s"></a>国内源安装k3s</h3>  <div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">curl -sfL https:&#x2F;&#x2F;docs.rancher.cn&#x2F;k3s&#x2F;k3s-install.sh | INSTALL_K3S_MIRROR&#x3D;cn INSTALL_K3S_EXEC&#x3D;&quot;server --no-deploy&#x3D;traefik --kube-apiserver-arg service-node-port-range&#x3D;1-65535&quot; sh -<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>  关于安装参数，我们一条一条来解释：</p><blockquote><p>INSTALL_K3S_MIRROR：使用国内源安装</p><p>INSTALL_K3S_EXEC：安装参数</p><ul><li>–no-deploy=traefik：禁用traefik代理。traefik是k3s自带的反向代理，因为我们这里要使用istio做反代，所以把默认的traefik禁用。</li><li>–kube-apiserver-arg service-node-port-range=1-65535：端口映射范围，api-server默认可映射到宿主的端口范围是30000+，但是我们有些资源或者服务要映射到外部供外部调用，比如80、443、3306等……因此要更改默认范围。前面的–kube-apiserver-arg表示这是一个k8s服务的配置参数。具体可参考文档<a href="https://docs.rancher.cn/k3s/installation/install-options.html#_3-%E9%A2%9D%E5%A4%96%E7%9A%84%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9">额外的配置选项</a>。</li></ul></blockquote><h3 id="安装kubectl"><a href="#安装kubectl" class="headerlink" title="安装kubectl"></a>安装kubectl</h3><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 用阿里源安装cat &lt;&lt;EOF &gt; &#x2F;etc&#x2F;yum.repos.d&#x2F;kubernetes.repo[kubernetes]name&#x3D;Kubernetesbaseurl&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;repos&#x2F;kubernetes-el7-x86_64&#x2F;enabled&#x3D;1gpgcheck&#x3D;1repo_gpgcheck&#x3D;1gpgkey&#x3D;https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;yum-key.gpg https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;kubernetes&#x2F;yum&#x2F;doc&#x2F;rpm-package-key.gpgEOFsetenforce 0yum install -y kubelet kubeadm kubectl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="安装验证"><a href="#安装验证" class="headerlink" title="安装验证"></a>安装验证</h3><ul><li><p>检查节点状态</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ kubectl get node NAME   STATUS   ROLES    AGE     VERSIONvm6   Ready    master   5d23h   v1.18.3+k3s1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></li><li><p>检查节点的污点情况</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 请检查节点的污点情况，如果是false，则下面可以略过$ kubectl describe node vm6 | grep UnschedulableUnschedulable:      false# 因为我只有一台服务器，所以仅部署了master节点，正常master节点是不允许运行pod的，这里是对master做了污化# 移除node.kubernetes.io&#x2F;unschedulable，或执行以下命令$ kubectl taint nodes --all node-role.kubernetes.io&#x2F;master-$ kubectl taint nodes --all node-role.kubernetes.io&#x2F;master:PreferNoSchedule-# 这一步不确定性较大，如果都不可用，请自行根据文档解决，文档地址# https:&#x2F;&#x2F;kubernetes.io&#x2F;zh&#x2F;docs&#x2F;concepts&#x2F;configuration&#x2F;taint-and-toleration&#x2F;#%E6%A6%82%E5%BF%B5<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>检查dns解析情况</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ nslookup kubernetes.defaultServer:    10.0.0.10Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.localName:      kubernetes.defaultAddress 1: 10.0.0.1 kubernetes.default.svc.cluster.local# 如果显示NODOMAIN等，请修改&#x2F;etc&#x2F;resolv.conf,添加dnsip和search# 获取kube-dns的endpoint ip$ kubectl get endpoints -n kube-system | grep kube-dnskube-dns                10.42.0.54:53,10.42.0.54:9153,10.42.0.54:53   6d$ vim &#x2F;etc&#x2F;resolv.conf# nameserver放在第一行nameserver 10.42.0.54search default.svc.cluster.local svc.cluster.local svc.cluster.local cluster.localoptions ndots:5# 若产生其他问题请根据文档解决# https:&#x2F;&#x2F;kubernetes.io&#x2F;zh&#x2F;docs&#x2F;tasks&#x2F;debug-application-cluster&#x2F;debug-service&#x2F;#service-%E6%98%AF%E5%90%A6%E9%80%9A%E8%BF%87-dns-%E5%B7%A5%E4%BD%9C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="文档地址"><a href="#文档地址" class="headerlink" title="文档地址"></a>文档地址</h2></li></ul><p><a href="https://docs.rancher.cn/k3s/">K3S中文文档</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>k3s</tag>
      
      <tag>k8s</tag>
      
      <tag>istio</tag>
      
      <tag>mysql</tag>
      
      <tag>redis</tag>
      
      <tag>gateway</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java线程池配置详解</title>
    <link href="/2020/05/27/java%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"/>
    <url>/2020/05/27/java%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="java线程池配置详解"><a href="#java线程池配置详解" class="headerlink" title="java线程池配置详解"></a>java线程池配置详解</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网络资料多是复制粘贴，在此重写，以我为准。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul><li><p>4核</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 核心线程池大小</span><span class="token keyword">private</span> <span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token comment">// 最大可创建的线程数</span><span class="token keyword">private</span> <span class="token keyword">int</span> maxPoolSize <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span><span class="token comment">// 队列最大长度</span><span class="token keyword">private</span> <span class="token keyword">int</span> queueCapacity <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span><span class="token comment">// 线程池维护线程所允许的空闲时间</span><span class="token keyword">private</span> <span class="token keyword">int</span> keepAliveSeconds <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><a id="more"></a></li><li><p>2核</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 核心线程池大小</span><span class="token keyword">private</span> <span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">// 最大可创建的线程数</span><span class="token keyword">private</span> <span class="token keyword">int</span> maxPoolSize <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span><span class="token comment">// 队列最大长度</span><span class="token keyword">private</span> <span class="token keyword">int</span> queueCapacity <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span><span class="token comment">// 线程池维护线程所允许的空闲时间</span><span class="token keyword">private</span> <span class="token keyword">int</span> keepAliveSeconds <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>1核</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 核心线程池大小</span><span class="token keyword">private</span> <span class="token keyword">int</span> corePoolSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">// 最大可创建的线程数</span><span class="token keyword">private</span> <span class="token keyword">int</span> maxPoolSize <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token comment">// 队列最大长度</span><span class="token keyword">private</span> <span class="token keyword">int</span> queueCapacity <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span><span class="token comment">// 线程池维护线程所允许的空闲时间</span><span class="token keyword">private</span> <span class="token keyword">int</span> keepAliveSeconds <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2></li></ul><p>ThreadPoolExecutor类可设置的参数主要有：</p><ul><li><p><code>corePoolSize</code></p><blockquote><p>核心线程数，核心线程会一直存活，即使没有任务需要处理。当线程数小于核心线程数时，即使现有的线程空闲，线程池也会优先创建新线程来处理任务，而不是直接交给现有的线程处理。</p><p>核心线程在allowCoreThreadTimeout被设置为true时会超时退出，默认情况下不会退出。</p></blockquote></li><li><p><code>maxPoolSize</code></p><blockquote><p>当线程数大于或等于核心线程，且任务队列已满时，线程池会创建新的线程，直到线程数量达到maxPoolSize。如果线程数已等于maxPoolSize，且任务队列已满，则已超出线程池的处理能力，线程池会拒绝处理任务而抛出异常。</p></blockquote></li><li><p><code>keepAliveSeconds</code></p><blockquote><p>当线程空闲时间达到keepAliveSeconds，该线程会退出，直到线程数量等于corePoolSize。如果allowCoreThreadTimeout设置为true，则所有线程均会退出直到线程数量为0。</p></blockquote></li><li><p><code>allowCoreThreadTimeout</code></p><blockquote><p>是否允许核心线程空闲退出，默认值为false。</p></blockquote></li><li><p><code>queueCapacity</code></p><blockquote><p>任务队列容量。从maxPoolSize的描述上可以看出，任务队列的容量会影响到线程的变化，因此任务队列的长度也需要恰当的设置。</p></blockquote></li></ul><h2 id="扩容流程："><a href="#扩容流程：" class="headerlink" title="扩容流程："></a>扩容流程：</h2><p><img src="1590563487338.png" alt="线程池"></p><h2 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h2><h3 id="corePoolSize"><a href="#corePoolSize" class="headerlink" title="corePoolSize"></a>corePoolSize</h3><p>任务主要分为两类<strong>计算密集型</strong>和<strong>IO密集型</strong></p><p>目前大多数cpu都是多核多线程，像我是6核12线程，因此以往的用cpu核数计算并不恰当，应以实际线程数为主。</p><p>注意：有些cpu说是4核8线程，但实际上是6线程+2虚拟线程，此时要用6来计算。</p><p>或者直接一把梭：Runtime.getRuntime().availableProcessors()</p><p>在计算<code>corePoolSize</code>时涉及到一个阻塞系数的概念。</p><blockquote><p>如果任务有50%的时间处于阻塞状态，则阻塞系数为0.5。则程序所需的线程数为处理器可用核心数的两倍。如果任务被阻塞的时间少于50%，即这些任务是计算密集型的，则程序所需线程数将随之减少，但最少也不应该低于处理器的核心数。如果任务被阻塞的时间大于执行时间，即该任务是IO密集型的，我们就需要创建比处理器核心数大几倍数量的线程。</p></blockquote><p>计算公式：线程数 =cpu实际线程数/(1 - 阻塞系数)，其中阻塞系数的取值在0和1之间。计算密集型人物的阻塞系数为0，而IO密集型任务的阻塞系数则接近1。</p><p>通用的说，计算密集型的<code>corePoolSize</code>=cpu实际线程数+1</p><p>IO密集型的<code>corePoolSize</code>=cpu实际线程数*5</p><h3 id="queueCapacity"><a href="#queueCapacity" class="headerlink" title="queueCapacity"></a>queueCapacity</h3><p>任务队列的长度要根据核心线程数，以及系统对任务响应时间的要求有关。队列长度计算公式为(corePoolSize/tasktime)*responsetime。</p><p>一般来说，tasktime是0.1，responsetime是2，因此等价于</p><p>queueCapacity=20*corePoolSize</p><h3 id="maxPoolSize"><a href="#maxPoolSize" class="headerlink" title="maxPoolSize"></a>maxPoolSize</h3><p>如果需要最大线程池扩容，则说明任务队列已满。在这种情况下，对于计算密集型的任务，扩容线程池意义不是很大，因为不需要上下文的切换，这种情况下建议增加物理核数；对于IO密集型的任务，说明IO的速度变慢，需要将空闲的cpu资源让给后续的线程，需要增加线程池的容量。</p><p>一般来说，我们设置为core的4倍。</p><p>maxPoolSize=4*corePoolSize</p><h3 id="keepAliveTime"><a href="#keepAliveTime" class="headerlink" title="keepAliveTime"></a>keepAliveTime</h3><p>此参数设置的最大意义是当线程池维持在一个较高的使用率，延长线程存活时间可以有效的提高处理速度，避免无用的创建-销毁线程。</p><p>keepAliveTime = 5*responsetime * corePoolSize</p><h3 id="allowCoreThreadTimeout"><a href="#allowCoreThreadTimeout" class="headerlink" title="allowCoreThreadTimeout"></a>allowCoreThreadTimeout</h3><p>此参数建议维持默认false，不建议核心线程也退出。</p>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>线程池， 多线程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>微信小程序+mpvue+vant的打开方式</title>
    <link href="/2019/12/20/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-mpvue-vant%E7%9A%84%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/"/>
    <url>/2019/12/20/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-mpvue-vant%E7%9A%84%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="微信小程序-mpvue-vant的打开方式"><a href="#微信小程序-mpvue-vant的打开方式" class="headerlink" title="微信小程序+mpvue+vant的打开方式"></a>微信小程序+mpvue+vant的打开方式</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前阵子使用mpvue构建微信小程序，在引入其他框架时出现了一点问题，需要去修改配置，这里给出具体的配置流程。</p><a id="more"></a><h2 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h2><p>按照正常流程创建工程</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vue init mpvue&#x2F;mpvue-quickstart democd demonpm install# 这一步是选择依赖是否在开发环境安装，可根据工程实际情况自行配置npm i vant-weapp -S --production<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="修改webpack"><a href="#修改webpack" class="headerlink" title="修改webpack"></a>修改webpack</h2><p>在项目根目录下找到<code>build/webpack.base.conf.js</code>，在<code>baseWebpackConfig.plugins</code>中添加以下代码</p><div class="code-wrapper"><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">CopyWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">[</span>      <span class="token punctuation">&#123;</span>        <span class="token keyword">from</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'node_modules/vant-weapp/dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        to<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/wx/vant-weapp/dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.*'</span><span class="token punctuation">]</span>      <span class="token punctuation">&#125;</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="引入组件"><a href="#引入组件" class="headerlink" title="引入组件"></a>引入组件</h2><p>这里只需要在<code>src/app.json</code>中添加所需要的组件即可，不需要在vue文件中再次import</p><div class="code-wrapper"><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token string">"usingComponents"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>  <span class="token string">"van-button"</span><span class="token operator">:</span> <span class="token string">"vant-weapp/dist/button/index"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>实际上思路还是很明确的，微信的npm是自成一体，所以需要把工程中引入的第三方npm包复制到微信的npm中一份。在引入完毕后，在<code>app.json</code>中统一进行组件的引入。</p><p>另外可能出现这样的报错</p><p><img src="image-20191220102739192.png" alt="image-20191220102739192"></p><p>这个时候打开微信的转译就好了，把es6编译成es5</p>]]></content>
    
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>微信小程序</tag>
      
      <tag>mpvue</tag>
      
      <tag>vant</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>关于docker版nginx的几点注意</title>
    <link href="/2019/11/16/%E5%85%B3%E4%BA%8Edocker%E7%89%88nginx%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F/"/>
    <url>/2019/11/16/%E5%85%B3%E4%BA%8Edocker%E7%89%88nginx%E7%9A%84%E5%87%A0%E7%82%B9%E6%B3%A8%E6%84%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="关于docker版nginx的几点注意"><a href="#关于docker版nginx的几点注意" class="headerlink" title="关于docker版nginx的几点注意"></a>关于docker版nginx的几点注意</h1><ol><li>在启动nginx时，如果使用<code>-v</code>参数映射了宿主机目录，用来映射配置文件，日志等文件，则需要预先创建好，不然会报文件not found。</li><li>如果在启动时，使用了命令，如<code>nginx -c</code>等，则需要在配置文件种加上<code>daemon off;</code>或者<code>nginx -g &#39;daemon off;&#39;</code>,这使nginx转入后台运行，避免docker启动后因在前台运行导致立刻停机。</li><li>如果在<code>nginx.conf</code>中，配置了路由转发，并且所转发到的服务未使用docker构建，则要使用本机ip或域名访问，不可使用<code>localhost</code>或者<code>127.0.0.1</code>，会导致无法访问（404），因为docker使用的网络默认使docker的内网（bridge）。如果想要使用<code>localhost</code>等，请将<code>network</code>设置为<code>host</code>（<code>--network host</code>）</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用flex制作滚动列表</title>
    <link href="/2019/11/03/%E4%BD%BF%E7%94%A8flex%E5%88%B6%E4%BD%9C%E6%BB%9A%E5%8A%A8%E5%88%97%E8%A1%A8/"/>
    <url>/2019/11/03/%E4%BD%BF%E7%94%A8flex%E5%88%B6%E4%BD%9C%E6%BB%9A%E5%8A%A8%E5%88%97%E8%A1%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="使用flex制作滚动列表"><a href="#使用flex制作滚动列表" class="headerlink" title="使用flex制作滚动列表"></a>使用flex制作滚动列表</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为自己在做一点小东西，所以就有个需求，一个元素里面需要有两个子元素，两个子元素竖排排列，第二个子元素里面的内容不定长，需要做滚动，但第二个元素的高度需要自适应。</p><p>在学习的过程稿发现flex和overflow挺有意思的，特此记录下来。</p><a id="more"></a><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><div class="code-wrapper"><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span> <span class="token property">background</span><span class="token punctuation">:</span> #66ccff</span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">    <span class="token selector">*</span> <span class="token punctuation">&#123;</span>      <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>      <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">.parent</span> <span class="token punctuation">&#123;</span>      <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>      <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>      <span class="token property">height</span><span class="token punctuation">:</span> 500px<span class="token punctuation">;</span>      <span class="token property">overflow</span><span class="token punctuation">:</span> hidden    <span class="token punctuation">&#125;</span>    <span class="token selector">ul</span> <span class="token punctuation">&#123;</span>      <span class="token property">overflow</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>      <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token selector">li</span> <span class="token punctuation">&#123;</span>      <span class="token property">height</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span>      <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><!DOCTYPE html><html lang="en"><head>  <meta charset="UTF-8">  <meta name="viewport" content="width=device-width, initial-scale=1.0">  <meta http-equiv="X-UA-Compatible" content="ie=edge">  <title>Document</title></head><body>  <div class="parent">    <div style="height: 200px; background: #66ccff">标题</div>    <ul>      <li>1</li>      <li>2</li>      <li>3</li>      <li>4</li>      <li>5</li>      <li>6</li>    </ul>  </div>  <style>    * {      padding: 0;      margin: 0;    }    .parent {      display: flex;      flex-direction: column;      height: 500px;      overflow: hidden    }    ul {      overflow: auto;    }    li {      height: 200px;      border: 1px solid #ccc;    }  </style></body></html><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先是<code>.parent</code>。将display设置为弹性布局，并且规定了布局方向为竖排，对于溢出元素的处理方式设置为隐藏。这样的情况下，html就会将这个元素里面的布局重置，保证了里面的元素可以自适应高度，不会出现子元素与父元素高度相同的情况，并且对于移除内容进行了隐藏</p><p>第二就是<code>ul</code>。对于其中<code>ul</code>其中的溢出元素做了自动处理，实际上是将溢出元素设置为滚动，这样ul里面的元素就可以进行滚动。</p><p>第三要注意<code>height</code>。如果要求<code>ul</code>为自适应，则height一定为<code>100%</code>（或者<code>inherit</code>）,并且父级元素需要显式的设置高度，不能为<code>auto</code></p>]]></content>
    
    
    
    <tags>
      
      <tag>html</tag>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>nginx匹配规则</title>
    <link href="/2019/10/17/nginx%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99/"/>
    <url>/2019/10/17/nginx%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99/</url>
    
    <content type="html"><![CDATA[<h2 id="一、语法规则"><a href="#一、语法规则" class="headerlink" title="一、语法规则"></a>一、语法规则</h2><div class="code-wrapper"><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">|</span><span class="token operator">~</span><span class="token operator">|</span><span class="token operator">~</span><span class="token operator">*</span><span class="token operator">|</span><span class="token operator">^</span><span class="token operator">~</span><span class="token punctuation">]</span> <span class="token operator">/</span>uri<span class="token operator">/</span> <span class="token punctuation">&#123;</span> … <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><table><thead><tr><th align="center">符&nbsp;号</th><th align="left">含&nbsp;义</th></tr></thead><tbody><tr><td align="center"><code>=</code></td><td align="left">开头表示精确匹配</td></tr><tr><td align="center"><code>^~</code></td><td align="left">开头表示 uri 以某个常规字符串开头，理解为匹配 <code>url</code> 路径即可。<code>nginx</code> 不对 <code>url</code> 做编码，因此请求为<code>/static/20%/aa</code>，可以被规则<code>^~ /static/ /aa</code>匹配到（注意是空格）</td></tr><tr><td align="center"><code>~</code></td><td align="left">开头表示区分大小写的正则匹配</td></tr><tr><td align="center"><code>~*</code></td><td align="left">开头表示不区分大小写的正则匹配</td></tr><tr><td align="center"><code>/</code></td><td align="left">通用匹配，任何请求都会匹配到</td></tr></tbody></table><a id="more"></a><h4 id="多个-location-配置的情况下匹配顺序为"><a href="#多个-location-配置的情况下匹配顺序为" class="headerlink" title="多个 location 配置的情况下匹配顺序为"></a>多个 location 配置的情况下匹配顺序为</h4><blockquote><ul><li>首先匹配 <code>=</code></li><li>其次匹配 <code>^~</code></li><li>其次是按文件中顺序的正则匹配</li><li>最后是交给 / 通用匹配</li><li>当有匹配成功时候，停止匹配，按当前匹配规则处理请求</li></ul></blockquote><div class="code-wrapper"><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>   <span class="token comment">#规则A</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>login <span class="token punctuation">&#123;</span>   <span class="token comment">#规则B</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>static<span class="token operator">/</span> <span class="token punctuation">&#123;</span>   <span class="token comment">#规则C</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>   <span class="token comment">#规则D</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span>png$ <span class="token punctuation">&#123;</span>   <span class="token comment">#规则E</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>   <span class="token comment">#规则F</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><blockquote><p>那么产生的效果如下：</p><ul><li>访问根目录 /， 比如 <a href="http://localhost/">http://localhost/</a> 将匹配规则 A</li><li>访问 <a href="http://localhost/login">http://localhost/login</a> 将匹配规则 B，<a href="http://localhost/register">http://localhost/register</a> 则匹配规则 F</li><li>访问 <a href="http://localhost/static/a.html">http://localhost/static/a.html</a> 将匹配规则 C</li><li>访问 <a href="http://localhost/a.gif">http://localhost/a.gif</a>, <a href="http://localhost/b.jpg">http://localhost/b.jpg</a> 将匹配规则 D和规则 E，但是规则 D 顺序优先，规则 E不起作用，而 <a href="http://localhost/static/c.png%E5%88%99%E4%BC%98%E5%85%88%E5%8C%B9%E9%85%8D%E5%88%B0%E8%A7%84%E5%88%99">http://localhost/static/c.png则优先匹配到规则</a> C</li><li>访问 <a href="http://localhost/a.PNG">http://localhost/a.PNG</a> 则匹配规则 E，而不会匹配规则 D，因为规则 E 不区分大小写</li><li>访问 <a href="http://localhost/category/id/1111">http://localhost/category/id/1111</a> 则最终匹配到规则 F，因为以上规则都不匹配，这个时候应该是 nginx 转发请求给后端应用服务器，比如 FastCGI（PHP），tomcat（jsp），nginx 作为反向代理服务器存在</li></ul></blockquote><h2 id="二、运用场景"><a href="#二、运用场景" class="headerlink" title="二、运用场景"></a>二、运用场景</h2><h4 id="实际使用中，至少有三个匹配规则定义，如下："><a href="#实际使用中，至少有三个匹配规则定义，如下：" class="headerlink" title="实际使用中，至少有三个匹配规则定义，如下："></a>实际使用中，至少有三个匹配规则定义，如下：</h4><div class="code-wrapper"><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 直接匹配网站根，通过域名访问网站首页比较频繁，使用这个会加速处理，官网如是说。</span><span class="token comment"># 这里是直接转发给后端应用服务器了，也可以是一个静态首页</span><span class="token comment"># 第一个必选规则</span><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>tomcat<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">&#125;</span><span class="token comment"># 第二个必选规则是处理静态文件请求，这是 nginx 作为 http 服务器的强项</span><span class="token comment"># 有两种配置模式，目录匹配或后缀匹配，任选其一或搭配使用</span><span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>static<span class="token operator">/</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">root</span> <span class="token operator">/</span>webroot<span class="token operator">/</span>static<span class="token operator">/</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span>ico<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>    <span class="token keyword">root</span> <span class="token operator">/</span>webroot<span class="token operator">/</span>res<span class="token operator">/</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment"># 第三个规则就是通用规则，用来转发动态请求到后端应用服务器</span><span class="token comment"># 非静态文件请求就默认是动态请求，自己根据实际把握</span><span class="token comment"># 毕竟目前的一些框架的流行，带.php、.jsp后缀的情况很少了</span><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>tomcat<span class="token punctuation">:</span><span class="token number">8080</span><span class="token operator">/</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    
    <tags>
      
      <tag>nginx</tag>
      
      <tag>服务器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux常用命令</title>
    <link href="/2019/10/17/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2019/10/17/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<p>内存资源最多的前 10 个进程</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ps -auxf | sort -nr -k 4 | head -10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p> CPU 资源最多的前 10 个进程 </p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ps -auxf | sort -nr -k 3 | head -10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>find在根目录下根据文件名查找</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">find &#x2F; -name 文件名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><a id="more"></a><h3 id="NGINX-一般目录"><a href="#NGINX-一般目录" class="headerlink" title="NGINX 一般目录"></a>NGINX 一般目录</h3><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 启动文件&#x2F;usr&#x2F;src&#x2F;nginx&#x2F;sbin&#x2F;nginx# 配置文件&#x2F;usr&#x2F;src&#x2F;nginx&#x2F;conf&#x2F;nginx.conf# 日志目录&#x2F;usr&#x2F;src&#x2F;nginx&#x2F;logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="SSH-KEY-生成"><a href="#SSH-KEY-生成" class="headerlink" title="SSH KEY 生成"></a>SSH KEY 生成</h3><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ssh-keygen -t rsa -C &quot;your_email@example.com&quot;# 三连回车ssh-agent -seval &#96;ssh-agent -s&#96;ssh-add ~&#x2F;.ssh&#x2F;id_rsa<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h3 id="建立swap分区"><a href="#建立swap分区" class="headerlink" title="建立swap分区"></a>建立swap分区</h3><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#1.创建要作为swap分区的文件:增加1GB大小的交换分区，则命令写法如下，其中的count等于想要的块的数量（bs*count&#x3D;文件大小）。dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;&#x2F;root&#x2F;swapfile bs&#x3D;1M count&#x3D;1024#2.格式化为交换分区文件:mkswap &#x2F;root&#x2F;swapfile#3.启用交换分区文件:swapon &#x2F;root&#x2F;swapfile#4.使系统开机时自启用，在文件&#x2F;etc&#x2F;fstab中添加一行：echo &quot;&#x2F;root&#x2F;swapfile swap swap defaults 0 0&quot; &gt;&gt;&#x2F;etc&#x2F;fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>运维</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>服务器自动部署脚本</title>
    <link href="/2019/09/10/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/"/>
    <url>/2019/09/10/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="服务器自动部署脚本"><a href="#服务器自动部署脚本" class="headerlink" title="服务器自动部署脚本"></a>服务器自动部署脚本</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>自搭服务器需要自动打包部署流程，写了个脚本，备忘。</p><p>没有特殊需求直接放在工程根目录下就可以。</p><a id="more"></a><h2 id="SHELL脚本"><a href="#SHELL脚本" class="headerlink" title="SHELL脚本"></a>SHELL脚本</h2><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;usr&#x2F;bin&#x2F;env bash# 刷新环境变量source &#x2F;etc&#x2F;profile# [$1]会作为git的分支信息处理# 工程路径, 绝对路径dirPath&#x3D;&#39;DIR_PATH&#39;# 项目名称appName&#x3D;&#39;PROJECT_NAME&#39;# 端口号, 会根据端口号关闭进程port&#x3D;8080############# 工具方法 ################################ 自动stash，如果存在更改的内容function autoStash() &#123;  if [ &quot;$(git status --porcelain | wc -l)&quot; -gt 0 ]  then    git stash push -m &quot;auto stash at: $(date)&quot;  fi&#125;## 非阻塞延迟2-3秒function delay() &#123;  echo &quot;loading...&quot;  ti1&#x3D;$(date +%s)    #获取时间戳  ti2&#x3D;$ti1  while [[ &quot;$((ti2 - ti1 ))&quot; -le 2 ]]  do  ti2&#x3D;$(date +%s)  done&#125;###################################################     start to run application                   #################################################### 拉取新代码并打包if $dirPath then cd $dirPathfi# 自动stashautoStash# 支持外部传递分支名称，没有则按当前默认分支处理if [ -n &quot;$1&quot; ] &amp;&amp; [ &quot;$1&quot; !&#x3D; &quot;$(git branch --show-current)&quot; ]then  branch&#x3D;$1  git checkout &quot;$branch&quot;  git pull origin &quot;$branch&quot;else  git pullfimvn clean package -U -DskipTests&#x3D;true# 根据端口号查询对应的pid，并删除服务进程pid&#x3D;$(netstat -nlp | grep :$port | awk &#39;&#123;print $7&#125;&#39; | awk -F&quot;&#x2F;&quot; &#39;&#123; print $1 &#125;&#39;);echo &quot;$pid&quot;if [  -n  &quot;$pid&quot;  ];  then    kill  -9  &quot;$pid&quot;;fi# 删除老文件，复制新文件rm $dirPath&#x2F;app&#x2F;$appName.jar -frm $dirPath&#x2F;logs&#x2F;$appName.log -fmv .&#x2F;target&#x2F;app.jar .&#x2F;target&#x2F;$appName.jar# 启动项目cd $dirPath&#x2F; || mkdir logs || exitnohup java -jar -Xms512m -Xmx1024m \ .&#x2F;target&#x2F;$appName.jar &gt; .&#x2F;logs&#x2F;$appName.log 2&gt;&amp;1 &amp;# 添加一点延迟，等待日志文件创建，避免tail失败delaytail -f .&#x2F;logs&#x2F;$appName.log -n 200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="maven打包配置"><a href="#maven打包配置" class="headerlink" title="maven打包配置"></a>maven打包配置</h2><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>finalName</span><span class="token punctuation">></span></span>app<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>finalName</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resources</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>src/main/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span>**/*.properties<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>src/main/resources<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span>**/**<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>resource</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>src<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span>**/*.sh<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filtering</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filtering</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resource</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>resources</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-resources-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonFilteredFileExtensions</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>xlsx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>xls<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>ttf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>ttc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonFilteredFileExtension</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nonFilteredFileExtensions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoding</span><span class="token punctuation">></span></span>$&#123;project.build.sourceEncoding&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoding</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-javadoc-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>skip</span><span class="token punctuation">></span></span>$&#123;maven.javadoc.skip&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>skip</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>attach-javadocs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>additionalOptions</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>additionalOption</span><span class="token punctuation">></span></span>                                -Xdoclint:none                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>additionalOption</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>additionalOptions</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>skip</span><span class="token punctuation">></span></span>$&#123;maven.springboot.skip&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>skip</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-surefire-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span>**/*Test.java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span><span class="token punctuation">></span></span>**/*Spec.java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>]]></content>
    
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>服务器</tag>
      
      <tag>springboot</tag>
      
      <tag>ops</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gitlab的specificRunner安装与注册</title>
    <link href="/2019/08/26/Gitlab%E7%9A%84specificRunner%E5%AE%89%E8%A3%85%E4%B8%8E%E6%B3%A8%E5%86%8C/"/>
    <url>/2019/08/26/Gitlab%E7%9A%84specificRunner%E5%AE%89%E8%A3%85%E4%B8%8E%E6%B3%A8%E5%86%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="Gitlab的specificRunner安装与注册"><a href="#Gitlab的specificRunner安装与注册" class="headerlink" title="Gitlab的specificRunner安装与注册"></a>Gitlab的specificRunner安装与注册</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这里使用docker版本的specificRunner，以下命令可直接使用。</p><p>注册时必须须替换<code>url</code>和 <code>registration-token</code>，其他项可按需求更改。</p><a id="more"></a><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol><li><p>拉下最新版本镜像</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker pull gitlab&#x2F;gitlab-runner<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p>启动启动容器</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker run -d --name gitlab-runner --restart always \  -v &#x2F;srv&#x2F;gitlab-runner&#x2F;config:&#x2F;etc&#x2F;gitlab-runner \  -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock \  gitlab&#x2F;gitlab-runner:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p>runner注册</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker exec -it gitlab-runner gitlab-runner register \  --non-interactive \  --executor &quot;docker&quot; \  --docker-image alpine:latest \  --url &quot;https:&#x2F;&#x2F;gitlab.com&#x2F;&quot; \  --registration-token &quot;PROJECT_REGISTRATION_TOKEN&quot; \  --description &quot;docker-runner&quot; \  --tag-list &quot;docker&quot; \<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><code>url</code>和 <code>registration-token</code>是在Gitlab的CI/CD页面</p><p><img src="1566811661513.png" alt="1566811661513"></p></li><li><p>检查注册是否成功</p><p><img src="1566811779484.png" alt="1566811779484"></p><p>绿色代表注册成功。</p><p><img src="1566811872456.png" alt="1566811872456"></p><p>如果ip与本机不同，不用担心，这是gitlab分配的地址，可以正常调用。</p></li><li><p>查看日志</p><div class="code-wrapper"><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker logs -f gitlab-runner<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果是虚拟机中的docker，则需要将虚拟机挂在到物理网络才可以连接。否则虽然虚拟机中的runner可以注册到gitlab，但gitlab无法访问</p></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>脚本,随笔</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>针对业务场景的解决方案</title>
    <link href="/2019/08/15/%E9%92%88%E5%AF%B9%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <url>/2019/08/15/%E9%92%88%E5%AF%B9%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h1 id="针对业务场景的解决方案"><a href="#针对业务场景的解决方案" class="headerlink" title="针对业务场景的解决方案"></a>针对业务场景的解决方案</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        这是一个系列专题，是根据我所经历的具体的业务场景所用到的解决方案和技术架构设计的一个汇总。</p><p>​        一方面是对一直以来的经历做一个总结，在以后做项目的时候有一个基础的想法。</p><p>​        另一方面是秉承这开源的精神，希望大家在接到甲方爸爸的需求时候，起码一个基本的解决方案的思路方向，不至于心里没底。</p><p>​        如果针对某一场景，在以后的工作中有更好的解决方案，我也会更新进来并说明原因及优劣。</p><a id="more"></a><h2 id="基础篇"><a href="#基础篇" class="headerlink" title="基础篇"></a>基础篇</h2><p>​        基础篇包括表设计原则，API设计原则，工程结构设计原则，事务设计原则</p><h3 id="表设计原则"><a href="#表设计原则" class="headerlink" title="表设计原则"></a>表设计原则</h3><h4 id="锁的设计"><a href="#锁的设计" class="headerlink" title="锁的设计"></a>锁的设计</h4><p>​        乐观锁和悲观锁都是经常使用的锁，现在大多使用的都是乐观锁，悲观锁由于其特性（一人编辑，其他人无法做任何操作，包括查看）很少被使用，这里不作赘述，现在主要是对于锁存在的情况下，异步更新数据所引发的问题。</p><blockquote><p>场景：</p><p>​        在一个订单系统中，用到的数据库是TiDB，采用乐观锁。订单在提交后，需要将数据导出到外部系统，并且在外部系统生成外部系统订单号，由于外部系统的响应时间不确定，因此需要做成异步。</p><p>问题：</p><p>​        由于TiDB的默认事务级别是<code>快照隔离</code>，并不是他文档上描述的<code>可重复读</code>。因此在主线程事务没有提交时，异步线程开启，此时主线程的事务还未提交，这时候订单的版本号并不是最新的，如果异步事务根据这个版本号更新，则会发生无法更新的异常，异步事务直接结束。</p><p>解决：</p><p>​        订单增加回传状态flag相关字段，并将异步回传的事务提取出来，与订单能正常提交的事务拆开，两个事务放在controller层。在确定订单提交事务的提交后，再进行异步事务。是否成功更新回传flag。</p><p>预防：</p><p>​        两手准备：</p><ol><li>应把异步字段单独提取出来形成一张表，表中不应含有锁字段<code>版本号</code>。这样可以解决锁的问题</li><li>在调用异步方法时，应直接传入最新的对象，不应传入对象的主键ID在再异步方法中查出数据。这样可以解决数据库隔离级别的问题。</li></ol></blockquote><h4 id="字段的设计"><a href="#字段的设计" class="headerlink" title="字段的设计"></a>字段的设计</h4><p>​        对于业务单据来说，字段主要分为两大类：<code>状态字段</code>、<code>值字段</code>、<code>管控维度字段</code>。状态字段包括新建状态，提交状态等；值字段包括金额，数量等；管控维度字段包括公司，业务实体，采购组织等。</p><blockquote><p>状态字段：</p><p>​        状态字段需要记录三点：状态FLAG，状态操作人，状态操作时间</p><p>​        如果头状态需要根据行状态算出来，则要根据具体业务判断头状态是设置FLAG还是CODE</p><p>​        状态需要分为状态CODE和状态FLAG，某种状态可以结合当前状态及标志位算出来。头状态的数量一般为``行状态数量阶乘-1(n!-1)`注意不要落下。</p><p>​        状态操作人如果有多个，建议做成行转列，之后进行扩展也比较容易。</p><p>值字段：</p><p>​        值字段包括金额，数量等，这些在数据库中要注意小数点位数，java中注意要中BigDeciaml类型，防止精度丢失。</p><p>管控维度字段：</p><p>​        管控维度字段比较有争议的地方就是应该放在头上还是行上。这里需要看业务的具体要求和单据类型。以采购订单为例，供应商自然是要放在头上的，而物料肯定是要放在行上的。</p><p>​        然后是头行上都有管控字段。这种情况一定要和产品商量好，如果行上字段的数据不一致，头应该怎么处理。举个订单上税率的例子，行上有税率（行税率），头上有税率（头税率），当行税率不一致，头税率怎么取（整张订单该以何种税率结算？）</p><p>​        还有一点就是冗余设计。这种字段一般都配有code和name，是否需要在当前业务表上冗余这些字段，则要看单据是否要存储当前时间点信息，则需要冗余；如果要和管控字段的实时信息一致，则不要冗余。</p></blockquote><h3 id="API设计原则"><a href="#API设计原则" class="headerlink" title="API设计原则"></a>API设计原则</h3><p>API需要符合restful设计原则，这里对restful不作解释，只对细节作一些说明。</p><h4 id="API连接符"><a href="#API连接符" class="headerlink" title="API连接符"></a>API连接符</h4><blockquote><p>eg. PUT /v1/{orderId}/batch-enable</p><p>这是一个简单的restful风格的API，其中有几点需要作下说明</p><ol><li>连字符需要用中划线<code>-</code>，不要使用batchCreate因为使用驼峰某些古老的浏览器不支持。下划线也不要使用，URL中的hostname不允许使用下划线，统一风格使用<code>-</code>；而且用户体验不好（只按-键和shift+-键哪个更简单一点？）。</li><li>最好是加上版本号控制<code>/v1</code>，以后如果升级大版本可以直接<code>v2</code>，对外兼容性好，不需要再改动原本url</li><li>启用禁用功能不要让外部传递flag，而应该是系统暴露启用禁用端口。</li></ol></blockquote><h3 id="工程结构设计原则"><a href="#工程结构设计原则" class="headerlink" title="工程结构设计原则"></a>工程结构设计原则</h3><p>使用DDD工程结构，可查看<a href="https://yukdawn.gitee.io/2019/07/28/DDD%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%EF%BC%88%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%EF%BC%89/"><strong>DDD项目结构（领域驱动设计）</strong></a>。方法封装粒度按照infra-&gt;domain-&gt;app的顺序从低到高。</p><h3 id="事务设计原则"><a href="#事务设计原则" class="headerlink" title="事务设计原则"></a>事务设计原则</h3><p>主要是两点，默认事务与独立事务，独立事务需要谨慎使用。</p>]]></content>
    
    
    
    <tags>
      
      <tag>解决方案</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DDD项目结构（领域驱动设计）</title>
    <link href="/2019/07/28/DDD%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%EF%BC%88%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%EF%BC%89/"/>
    <url>/2019/07/28/DDD%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%EF%BC%88%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="DDD项目结构（领域驱动设计）"><a href="#DDD项目结构（领域驱动设计）" class="headerlink" title="DDD项目结构（领域驱动设计）"></a>DDD项目结构（领域驱动设计）</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>DDD项目结构（领域驱动设计）这种工程结构模型我接触了一年多，虽然每个人都有不同的理解，不过相比于MVC的工程结构，对于代码结构的清晰度，还有业务逻辑的分层方面，DDD都是优于MVC的。</p><p>尽管每个人对DDD模型的理解不同，但大家的思路总归是一致的（api、app、domain、infra），争议之处在于一些包放置的层级以及代码分层。</p><p>因此这里记录了对DDD工程结构的理解，以后我会不定期更新。</p><p>互相分享，互相学习。</p><a id="more"></a><h2 id="总体概览"><a href="#总体概览" class="headerlink" title="总体概览"></a>总体概览</h2><p>先晒出工程目录：</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">├─ api│   ├─ controller│   ├─ dto├─ app│   ├─ service│   │  └─ impl├─ domain│   ├─ entity│   ├─ service│   │  └─ impl│   ├─ repository│   │  └─ impl│   ├─ vo├─ infra│   ├─ config│   ├─ constant│   ├─ util│   ├─ mappper│   ├─ feign<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>我会从下到上依次进行说明。</p><h2 id="infra（基础设施层）"><a href="#infra（基础设施层）" class="headerlink" title="infra（基础设施层）"></a>infra（基础设施层）</h2><p>infra主要负责基础资源的定义。</p><p>基础资源常见类型为以下几种：</p><ul><li>config</li><li>constant</li><li>utils</li><li>mapper</li><li>feign</li></ul><p>这里涉及到一个问题，什么是基础资源？</p><p>基础资源指的是工程用到的工具类、配置类、常量类（枚举类）、获取数据的接口（包括从数据库中获取数据的mapper层和从外部接口获取数据的feign层）。</p><p>基础资源构成了工程的骨架和常用工具，一个工程只有骨架（config，mapper，feign）齐全，工具（constant， utils）完备，才能正常进行开发。</p><h2 id="domain（领域层）"><a href="#domain（领域层）" class="headerlink" title="domain（领域层）"></a>domain（领域层）</h2><p>领域层是整个DDD模型的核心，是上层（app层）和下层（infra层）的桥梁</p><p>领域层主要分为三个包</p><ul><li>entity</li><li>repository</li><li>service</li><li>vo</li></ul><p><code>entity</code>对应的是实体层，也是业务对象的核心，数据库中表映射的对象就是实体类。</p><p>entity的基础意义是作为数据库表映射的<code>实体对象</code>。允许存在对实体类属性操作的封装方法。</p><p>比如说，现在有需求对这个实体进行一个取消操作。取消操作需要设置cancelFlag=0，并且设置取消日期和操作人。这时就可以对这个取消操作封装成一个方法。</p><p><code>repository</code>层对应的是资源库层，代表<code>对资源的操作</code>。在DDD模型中，mapper层仅能代表和数据库的交互操作，而DDD中资源这个概念并不仅仅指的是数据库的数据，还包括网络资源（http）和文件资源等。</p><p>并且业务逻辑中，最常见的是头行结构的业务数据，可在repository层进行头行操作的业务逻辑封装。</p><p>service层这里指的是<code>领域service层</code>（domain），并非是<code>应用service层</code>（app）。</p><p>这里的service层是对业务操作进行一个粗粒度的封装，但不是完全封装。完全封装是应用service层要做的事。</p><p>举个例子：有一个订单系统，有自动审批配置，如果自动审批开启，则要在订单提交后进行自动审批。</p><p>领域service层要做的就是封装两个方法，提交和审批方法，而判断是否进行自动审批，则应该交给应用service层去做</p><p>VO只负责数据流转，没有处理逻辑，负责对网络资源，数据库资源进行接收</p><h2 id="app（事务层）"><a href="#app（事务层）" class="headerlink" title="app（事务层）"></a>app（事务层）</h2><p>app层处理实际需求，进行事务控制，流程调度。</p><p>只有一层</p><ul><li>service</li></ul><p>app层需要对domain层，infra层的接口进行调用，并且要求实现对业务逻辑的完全封装（例如在domain层举的订单系统审批例子）。</p><p>另外，是否需要事务控制则需要根据需求进行具体分析</p><h2 id="api（接口层）"><a href="#api（接口层）" class="headerlink" title="api（接口层）"></a>api（接口层）</h2><p>api层做接口。负责与外界的数据交互。</p><p>api层主要分为两个包</p><ul><li>controller</li><li>dto</li></ul><p>controller层是整个系统和外部交互的端口，因此权限控制，资源访问方法控制（GET、POST、PUT、DELETE）、数据校验控制，数据防篡改控制，都要在这一层做</p><p>dto层则是负责接收外部系统传递的数据。</p><p>对于权限控制和数据控制方面，可在infra层定义相关的拦截器进行处理，controller层仅需要增加校验注解。这一层要尽可能的轻。</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>在这种工程结构下，DTO的作用实际上是被严重弱化了，仅仅起到了一个接收数据的作用。</p><p>还有事务方面，repository和domain是一定要加事务控制的，app则要根据具体业务逻辑来做。</p><p>之前接过一个需求，要求订单生成完毕后传入另一个系统，无论另一个系统返回什么都要生成订单，此时app层就需要做独立事务处理，因此是否要求事务控制之还是要看实际应用场景是什么。</p><p>另外还有数据库事务隔离级别的问题，比如mysql的默认级别是可重复读（使用mvcc的方式控制版本），tidb的默认级别是快照隔离，也因此被坑过。不过这个不在本文讨论范围之内，只是要强调事务控制要看具体场景，脱离实际应用都是空谈。</p>]]></content>
    
    
    <categories>
      
      <category>工程结构</category>
      
      <category>spring</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>工程结构,DDD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis拦截器--从基础到与Spring Boot整合</title>
    <link href="/2019/07/28/MyBatis%E6%8B%A6%E6%88%AA%E5%99%A8--%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E4%B8%8ESpring%20Boot%E6%95%B4%E5%90%88/"/>
    <url>/2019/07/28/MyBatis%E6%8B%A6%E6%88%AA%E5%99%A8--%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E4%B8%8ESpring%20Boot%E6%95%B4%E5%90%88/</url>
    
    <content type="html"><![CDATA[<h3 id="MyBatis拦截器–从基础到与Spring-Boot整合"><a href="#MyBatis拦截器–从基础到与Spring-Boot整合" class="headerlink" title="MyBatis拦截器–从基础到与Spring Boot整合"></a>MyBatis拦截器–从基础到与Spring Boot整合</h3><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>MyBatis拦截器是Java持久层框架，最近在研究拦截器的写法。本以为会很复杂，实际上从使用上来说，是很简单的。</p><p>本文主要介绍的时各个<strong>方法</strong>和<strong>注解</strong>的<code>含义</code>及<code>使用方式</code>，并且与springboot进行简单的整合。</p><a id="more"></a><p>话不多说，开始说明。</p><h4 id="关于拦截器"><a href="#关于拦截器" class="headerlink" title="关于拦截器"></a>关于拦截器</h4><p>Mybatis拦截器的写法很简单，需要继承<code>Interceptor</code>类，重写其中的<code>intercept()</code>、<code>plugin()</code>、<code>setProperties()</code>。</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>plugin</span><span class="token punctuation">;</span><span class="token comment">//import ingnore</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">;</span>  <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>具体如下：</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAuthorityDataInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>这是先说方法，再说注解</p><h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><ul><li><p><code>setProperties()</code>方法主要是用来从配置中获取属性。</p><p>如果是使用xml式配置拦截器，可在Mybatis配置文件中添加节点，属性可以以如下方式传递</p><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">interceptor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tk.mybatis.simple.plugin.XXXInterceptor<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>propl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>valuel<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prop2<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>如果在<code>Spring boot</code>中使用，则需要单独写一个配置类，如下：</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MybatisMapperAutoConfiguration</span><span class="token punctuation">&#123;</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">zipkinInterceptor</span><span class="token punctuation">(</span><span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token class-name">ZipkinInterceptor</span> zipkinInterceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipkinInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"prop1"</span><span class="token punctuation">,</span><span class="token string">"value1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        zipkinInterceptor<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>zipkinInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>如果说<strong>不需要配置属性</strong>，则在<code>spring boot</code>中，不需要去编写配置类，只需要像我一样在拦截器上加个<code>@Component</code>即可。</p></li><li><p><code>plugin()</code>方法用于指定哪些方法可以被此拦截器拦截。如下：</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Executor</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//表明只有Executor方法才会执行这个拦截器内的intercept()</span>        <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> target<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p><code>Plugin.wrap()</code>是个包装方法，如果需要此拦截器，则将此此拦截器连同入参中的<code>target</code>一起包装后返回，如果不需要则直接返回<code>target</code></p><p>另附具体<code>Plugin.wrap()</code>的源码：</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">></span><span class="token punctuation">></span></span> signatureMap <span class="token operator">=</span> <span class="token function">getSignatureMap</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> type <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> <span class="token function">getAllInterfaces</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>interfaces<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>        type<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        interfaces<span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> interceptor<span class="token punctuation">,</span> signatureMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token keyword">return</span> target<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li><li><p><code>intercept()</code>方法是用来对拦截的<code>sql</code>进行具体的操作。</p><p>这里拿分页插件<code>PageHelper</code>中的类<code>PageInterceptor</code>进行说明。</p><p>坐标：<code>com.github.pagehelper.PageInterceptor#intercept(Invocation)</code></p><p><img src="1543743905576.png" alt="1543743905576"></p><ol><li><p><code>invocation.getArgs()</code>是从入参<code>invocation</code>获取拦截器所拦截方法的参数，其参数顺序和<strong>被拦截的方法</strong>保持一致，这个<strong>参数的个数</strong>以及<strong>参数具体是什么</strong>我们下一步说到<code>@Signature</code>注解时会讲。</p></li><li><p>获取执行器，可以用<code>Executor</code>直接执行被我们修改过的sql，示例如下</p><p><img src="1543744369471.png" alt="1543744369471"></p><p>这里就是不继续执行原来的方法体中的内容，而是去执行我们修改后的sql并且返回。</p></li><li><p>关于返回值</p><p>除了以上这种直接去执行我们修改过sql的方式，如果我们想让方法继续执行下去也是可以的。</p><p>只需要返回：</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li></ol></li></ul><h5 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h5><p><code>MyBatis</code>拦截器用到了两个注解：<code>@Intercepts</code>和<code>@Signature</code></p><ul><li><p><code>@Intercepts</code></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Intercepts</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Signature</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>可以看到，其中是一个<code>Signature</code>类型的数组，意味着一个拦截器可以拦截多种方法。</p></li><li><p><code>@Signature</code></p><p><strong>Signature</strong>意为<strong>签名，署名</strong>。实际上作用也与语义相同：表明需要拦截方法的方法签名。</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Signature</span> <span class="token punctuation">&#123;</span>  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">String</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>有三个参数，</p><ul><li><code>type</code>：类型</li><li><code>method</code>：方法名称</li><li><code>args</code>：方法参数</li></ul><p>这三个参数可以确定一个方法。默认情况下， <code>MyBatis</code>允许使用插件（拦截器）来拦截的接口和包括以下几个。</p><ul><li>Executor ( update 、 query 、 flushStatements 、 commit 、 rollback 、 get Transaction、 close、 isClosed)</li><li>ParameterHandler ( getParameterObj ect、setParameters)</li><li>ResultSetHandler ( handleResul tSets 、 handleCursorResultSets 、 handleOutputParameters)</li><li>StatementHandler (prepare、 parameterize、 batch、 update、 query)</li></ul><p>实际上，我们只需要记住这几个接口名称就可以，其余我们可以根据实际需要去看源码来确定具体所需要拦截的类。</p><ul><li>以<code>Executor</code>的<code>query</code>方法举例说明<code>@Signature</code>是如何确定一个方法。</li></ul><p><img src="1543745710452.png" alt="1543745710452"></p><p>如果我们需要拦截第一个方法，只需要这么写<code>@Signature</code></p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CacheKey</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">BoundSql</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>可以注意看，<code>type</code>的值与<strong>类名</strong>相同，<code>method</code>与<strong>方法名</strong>相同，为了避免方法重载，<code>args</code>中指定了<strong>各个参数的类型和个数</strong>。</p><ul><li><p>如果我们想拦截多个方法，比如说上图1和2的方法我们都想拦截到，只需要再加个<code>@Signature</code>就可以，要记得<code>@Intercepts</code>的value可是数组啊</p></li><li><p>```java<br>@Intercepts(</p><div class="code-wrapper"><pre><code>&#123;    @Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;),    @Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;),&#125;</code></pre></div><p>)</p><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">#### 与Spring Boot整合与Spring Boot整合这一块就简单许多，有两种方法，其实在上文中已有交代1. 手写一个配置类   &#96;&#96;&#96;java   @Configuration   public class MybatisMapperAutoConfiguration&#123;       @Bean       public void zipkinInterceptor(SqlSessionFactory sqlSessionFactory) &#123;           ZipkinInterceptor zipkinInterceptor &#x3D; new ZipkinInterceptor();           Properties properties &#x3D; new Properties();           properties.setProperty(&quot;prop1&quot;,&quot;value1&quot;);           zipkinInterceptor.setProperties(properties);           sqlSessionFactory.getConfiguration().addInterceptor(zipkinInterceptor);       &#125;   &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li></ul></li></ul><ol start="2"><li><p>在拦截器上加<code>@Component</code>注解</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">"query"</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserAuthorityDataInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>在mybatis的xml文件中，使用的是ognl语法，然而在mybatis中new的变量，因类加载器不同，会导致<code>equals</code>或<code>==</code>永远是<code>false</code>，需要注意。</p></li></ol><h4 id="资料参考"><a href="#资料参考" class="headerlink" title="资料参考"></a>资料参考</h4><p>《MyBatis从入门到精通》——<strong>刘增辉</strong>（PageHelper作者）</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
